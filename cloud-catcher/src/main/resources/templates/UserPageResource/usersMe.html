<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudCatcher - My Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(180deg, #f4f7fb 0%, #eef4ff 100%);
        }
        .page-shell {
            max-width: 1100px;
            margin: 0 auto;
        }
        .section-card {
            border: 0;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(10, 37, 64, 0.08);
        }
        .thumb-card { position: relative; }
        .thumb-card img { width: 100%; height: 160px; object-fit: cover; }
        .drop-zone {
            border: 2px dashed #8ba7d5;
            border-radius: 1rem;
            padding: 2rem 1rem;
            text-align: center;
            background: #f9fbff;
            transition: all .18s ease;
        }
        .drop-zone.dragover {
            border-color: #0d6efd;
            background: #e8f1ff;
            transform: translateY(-1px);
        }
        .thumb-check { position: absolute; top: .5rem; right: .5rem; z-index: 3; }
        .delete-bar { position: sticky; bottom: 0; z-index: 20; }
        .hero-title {
            letter-spacing: .2px;
            font-weight: 700;
        }
        .cloud-action-btn {
            position: absolute;
            left: .5rem;
            right: .5rem;
            bottom: .5rem;
            z-index: 4;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4 py-md-5">
    <div class="page-shell">
            <div id="buy-quota-section" class="card section-card mb-3">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3 mb-2">
                        <div>
                            <h1 class="h3 hero-title mb-1">My Cloud Space</h1>
                            <p class="text-muted mb-0">Upload your sky photos and manage your cloud gallery.</p>
                            <div class="mt-2">
                                <span id="quota-badge" class="badge bg-secondary">Remaining quota: ...</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a class="btn btn-outline-secondary btn-sm" href="/">Back to home</a>
                            <a class="btn btn-primary btn-sm" href="/logout">Log out</a>
                        </div>
                    </div>
                    <p class="text-danger fw-semibold mt-2 mb-0" id="error"></p>
                </div>
            </div>

            <div class="card section-card mb-3">
                <div class="card-body">
                    <h2 class="h5">Upload cloud photos</h2>
                    <p class="text-muted mb-3">Drag and drop images below. Each file is uploaded to the cloud automatically.</p>
                    <div id="drop-zone" class="drop-zone mb-2">
                        <div class="fw-semibold">Drop images here</div>
                        <div class="text-muted small">PNG, JPG and other image formats</div>
                    </div>
                    <p id="upload-status" class="mt-2 mb-0"></p>
                </div>
            </div>

            <div class="card section-card mb-3">
                <div class="card-body">
                    <h2 class="h5 mb-3">Buy More Quota</h2>
                    <p class="text-muted mb-3">Need more classifications? Pick a package below.</p>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body d-flex flex-column">
                                    <h3 class="h6 mb-1">Starter</h3>
                                    <p class="text-muted mb-2">1 quota</p>
                                    <p class="fw-semibold mb-3">1€</p>
                                    <button class="btn btn-outline-primary mt-auto quota-buy-btn" data-package-quota="1" data-package-price="1€">Buy 1 quota</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="card h-100 border border-success shadow-sm">
                                <div class="card-body d-flex flex-column">
                                    <h3 class="h6 mb-1">Best Value</h3>
                                    <p class="text-success small fw-semibold mb-2">Limited time</p>
                                    <p class="text-muted mb-2">10 quota</p>
                                    <p class="fw-semibold mb-3">5€</p>
                                    <button class="btn btn-success mt-auto quota-buy-btn" data-package-quota="10" data-package-price="5€">Buy 10 quota</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body d-flex flex-column">
                                    <h3 class="h6 mb-1">Pro</h3>
                                    <p class="text-muted mb-2">30 quota</p>
                                    <p class="fw-semibold mb-3">15€</p>
                                    <button class="btn btn-outline-primary mt-auto quota-buy-btn" data-package-quota="30" data-package-price="15€">Buy 30 quota</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card section-card">
                <div class="card-body">
                    <h2 class="h5">Your cloud thumbnails</h2>
                    <div id="thumb-grid" class="row g-3"></div>
                </div>
            </div>
            <div id="delete-bar" class="delete-bar mt-3 d-none">
                <div class="alert alert-danger d-flex justify-content-between align-items-center mb-0 shadow-sm">
                    <span id="delete-count">0 selected</span>
                    <button id="delete-btn" type="button" class="btn btn-danger btn-sm">Delete selected</button>
                </div>
            </div>

            <div class="modal fade" id="cloudModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content bg-dark">
                        <div class="modal-header border-0">
                            <h5 class="modal-title text-white" id="cloudModalLabel">Cloud preview</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body d-flex justify-content-center align-items-center p-2">
                            <img id="cloudModalImage" alt="Cloud full view" class="img-fluid" style="max-height: 95vh; object-fit: contain;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion mt-3" id="debugAccordion">
                <div class="accordion-item border-0 rounded-3 overflow-hidden shadow-sm">
                    <h2 class="accordion-header" id="debugHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#debugCollapse" aria-expanded="false" aria-controls="debugCollapse">
                            Debug (OIDC and user payload)
                        </button>
                    </h2>
                    <div id="debugCollapse" class="accordion-collapse collapse" aria-labelledby="debugHeading" data-bs-parent="#debugAccordion">
                        <div class="accordion-body">
                            <p class="text-muted small mb-2">Authenticated with OIDC. Data source: <code>/api/users/me</code>.</p>
                            <div class="small fw-semibold mb-1">Current user JSON</div>
                            <pre id="payload" class="bg-dark text-light rounded p-3 small mb-3">Loading...</pre>
                            <div class="small fw-semibold mb-1">Current user clouds JSON</div>
                            <pre id="cloud-payload" class="bg-dark text-light rounded p-3 small mb-0">Loading...</pre>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>

<script>
    let currentUser = null;
    let cloudStream = null;
    const cloudState = new Map();

    function refreshQuotaBadge() {
        const quotaBadge = document.getElementById("quota-badge");
        if (!quotaBadge) return;
        if (!currentUser) {
            quotaBadge.textContent = "Remaining quota: unavailable";
            quotaBadge.className = "badge bg-secondary";
            return;
        }
        const quotaValue = currentUser.remainingQuota !== undefined && currentUser.remainingQuota !== null
            ? currentUser.remainingQuota
            : currentUser.quota;
        const quota = Number(quotaValue);
        if (Number.isFinite(quota)) {
            quotaBadge.textContent = "Remaining quota: " + quota;
            quotaBadge.className = "badge " + (quota <= 0 ? "bg-danger" : (quota <= 5 ? "bg-warning text-dark" : "bg-success"));
        } else {
            quotaBadge.textContent = "Remaining quota: unknown";
            quotaBadge.className = "badge bg-secondary";
        }
    }

    async function loadUser() {
        const payloadNode = document.getElementById("payload");
        const cloudPayloadNode = document.getElementById("cloud-payload");
        const errorNode = document.getElementById("error");
        try {
            const response = await fetch("/api/users/me", { headers: { "Accept": "application/json" } });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const user = await response.json();
            currentUser = user;
            payloadNode.textContent = JSON.stringify(user, null, 2);
            refreshQuotaBadge();
            if (!cloudPayloadNode.textContent || cloudPayloadNode.textContent === "Loading...") {
                cloudPayloadNode.textContent = "[]";
            }
            renderCloudsFromState();
        } catch (error) {
            errorNode.textContent = "Unable to load user data: " + error.message;
            payloadNode.textContent = "{}";
            cloudPayloadNode.textContent = "[]";
            currentUser = null;
            refreshQuotaBadge();
            renderCloudsFromState();
        }
    }

    function toCloudItems(payload) {
        if (Array.isArray(payload.clouds)) return payload.clouds;
        const names = payload.cloudObjectNames || [];
        return names.map((n) => ({ id: null, minioObjectName: n, cloudName: null }));
    }

    const selectedCloudIds = new Set();

    function extractDownloadTargetFromObjectName(objectName) {
        const name = String(objectName || "");
        const parts = name.split("/");
        if (parts.length >= 4 && parts[0] === "uploads" && parts[1] === "clouds") {
            return { userId: parts[2], fileName: parts.slice(3).join("/") };
        }
        if (parts.length >= 3 && parts[0] === "cloud") {
            return { userId: parts[1], fileName: parts.slice(2).join("/") };
        }
        return null;
    }

    function getCloudOwnerId(cloud) {
        if (cloud && cloud.downloadUserId) return String(cloud.downloadUserId);
        const target = extractDownloadTargetFromObjectName(cloud ? cloud.minioObjectName : "");
        return target ? String(target.userId || "") : "";
    }

    function userIdentityCandidates(user) {
        if (!user) return [];
        return [
            user.id,
            user.userId,
            user.sub,
            user.username,
            user.preferred_username
        ].filter((value) => value !== undefined && value !== null && String(value).trim() !== "").map((value) => String(value));
    }

    function cloudEntitiesForCurrentUser(clouds) {
        const identities = userIdentityCandidates(currentUser);
        if (identities.length === 0) return clouds;
        const filtered = clouds.filter((cloud) => identities.includes(getCloudOwnerId(cloud)));
        return filtered.length > 0 ? filtered : clouds;
    }

    function refreshDeleteBar() {
        const bar = document.getElementById("delete-bar");
        const count = document.getElementById("delete-count");
        count.textContent = selectedCloudIds.size + " selected";
        if (selectedCloudIds.size > 0) {
            bar.classList.remove("d-none");
        } else {
            bar.classList.add("d-none");
        }
    }

    function badgeLabelForCloud(cloud) {
        if (cloud && cloud.preventFurtherProcessing === true) {
            const label = String(cloud.deniedByLabel || "").trim();
            const normalized = label.toUpperCase();
            if (!label || normalized === "UNKNOWN" || normalized.includes("QUOTA")) {
                return "denied: out of quota. Buy more below.";
            }
            if (label) return "denied: reason " + label + " detected";
            return "denied";
        }
        return cloud && cloud.cloudName ? cloud.cloudName : "pending";
    }

    function isPendingCloud(cloud) {
        return !!cloud && cloud.preventFurtherProcessing !== true && (!cloud.cloudName || String(cloud.cloudName).trim() === "");
    }

    function isQuotaDeniedCloud(cloud) {
        if (!cloud || cloud.preventFurtherProcessing !== true) return false;
        const label = String(cloud.deniedByLabel || "").trim().toUpperCase();
        return !label || label === "UNKNOWN" || label.includes("QUOTA");
    }

    function hasAvailableQuota() {
        if (!currentUser) return false;
        const remainingValue = currentUser.remainingQuota !== undefined && currentUser.remainingQuota !== null
            ? currentUser.remainingQuota
            : currentUser.quota;
        const remaining = Number(remainingValue);
        return Number.isFinite(remaining) && remaining > 0;
    }

    function canRetryCloud(cloud) {
        if (isPendingCloud(cloud)) return true;
        if (isQuotaDeniedCloud(cloud)) return hasAvailableQuota();
        return false;
    }

    function requiresQuotaPurchase(cloud) {
        return isQuotaDeniedCloud(cloud) && !hasAvailableQuota();
    }

    function scrollToBuyQuotaSection() {
        const section = document.getElementById("buy-quota-section");
        if (section) {
            section.scrollIntoView({ behavior: "smooth", block: "start" });
        }
    }

    function badgeClassForCloud(cloud) {
        if (cloud && cloud.preventFurtherProcessing === true) {
            return "bg-danger";
        }
        if (cloud && cloud.cloudName) {
            return "bg-primary";
        }
        return "bg-secondary";
    }

    function cloudKey(cloud) {
        if (!cloud) return null;
        if (cloud.id !== undefined && cloud.id !== null) return "id:" + Number(cloud.id);
        const userId = String(cloud.downloadUserId || "").trim();
        const fileName = String(cloud.downloadFileName || "").trim();
        if (userId && fileName) return "file:" + userId + "/" + fileName;
        if (cloud.minioObjectName) return "minio:" + String(cloud.minioObjectName);
        return null;
    }

    function upsertCloudState(cloud) {
        const key = cloudKey(cloud);
        if (!key) return;
        cloudState.set(key, cloud);
    }

    function removeCloudState(cloud) {
        const key = cloudKey(cloud);
        if (!key) return;
        const previous = cloudState.get(key);
        if (previous && previous.id !== undefined && previous.id !== null) {
            selectedCloudIds.delete(Number(previous.id));
        } else if (cloud.id !== undefined && cloud.id !== null) {
            selectedCloudIds.delete(Number(cloud.id));
        }
        cloudState.delete(key);
    }

    function replaceCloudState(clouds) {
        cloudState.clear();
        clouds.forEach((cloud) => upsertCloudState(cloud));
    }

    function renderCloudsFromState() {
        const grid = document.getElementById("thumb-grid");
        const clouds = Array.from(cloudState.values());
        const userClouds = cloudEntitiesForCurrentUser(clouds);
        document.getElementById("cloud-payload").textContent = JSON.stringify(userClouds, null, 2);

        const validIds = new Set(
            userClouds
                .filter((cloud) => cloud.id !== undefined && cloud.id !== null)
                .map((cloud) => Number(cloud.id))
        );
        Array.from(selectedCloudIds).forEach((id) => {
            if (!validIds.has(id)) selectedCloudIds.delete(id);
        });

        if (userClouds.length === 0) {
            grid.innerHTML = '<div class="col-12 text-muted">No uploaded clouds yet.</div>';
            refreshDeleteBar();
            return;
        }

        grid.innerHTML = "";
        userClouds.forEach((cloud) => {
            const name = String(cloud.downloadFileName || cloud.minioObjectName || "");
            const target = (cloud && cloud.downloadUserId && cloud.downloadFileName)
                ? { userId: String(cloud.downloadUserId), fileName: String(cloud.downloadFileName) }
                : extractDownloadTargetFromObjectName(name);
            if (!target || !target.userId || !target.fileName) return;

            const col = document.createElement("div");
            col.className = "col-6 col-md-4 col-lg-3";

            const card = document.createElement("div");
            card.className = "card thumb-card shadow-sm border-0";

            const badge = document.createElement("span");
            badge.className = "position-absolute top-0 start-0 translate-middle-y badge rounded-pill " + badgeClassForCloud(cloud) + " ms-3 mt-2";
            badge.textContent = badgeLabelForCloud(cloud);

            const checkboxWrap = document.createElement("div");
            checkboxWrap.className = "thumb-check form-check";
            const checkbox = document.createElement("input");
            checkbox.className = "form-check-input";
            checkbox.type = "checkbox";
            checkbox.checked = cloud.id != null && selectedCloudIds.has(Number(cloud.id));
            checkbox.disabled = cloud.id == null;
            checkbox.title = cloud.id == null ? "Missing cloud id" : "Select for deletion";
            checkbox.addEventListener("click", (event) => event.stopPropagation());
            checkbox.addEventListener("change", () => {
                if (cloud.id == null) return;
                const id = Number(cloud.id);
                if (checkbox.checked) selectedCloudIds.add(id);
                else selectedCloudIds.delete(id);
                refreshDeleteBar();
            });
            checkboxWrap.appendChild(checkbox);

            const img = document.createElement("img");
            img.className = "card-img-top rounded";
            img.loading = "lazy";
            img.alt = name;
            img.src = "/cloud/" + encodeURIComponent(target.userId) + "/" + encodeURIComponent(target.fileName);
            img.style.cursor = canRetryCloud(cloud) ? "pointer" : "zoom-in";
            img.addEventListener("click", async () => {
                if (canRetryCloud(cloud) && cloud.id != null) {
                    await retryCloudClassification(Number(cloud.id), name);
                    return;
                }
                if (requiresQuotaPurchase(cloud)) {
                    scrollToBuyQuotaSection();
                    return;
                }
                openCloudModal(img.src, cloud.cloudName || name);
            });

            if ((canRetryCloud(cloud) || requiresQuotaPurchase(cloud)) && cloud.id != null) {
                const retryBtn = document.createElement("button");
                retryBtn.type = "button";
                retryBtn.className = "btn btn-warning btn-sm cloud-action-btn";
                retryBtn.textContent = requiresQuotaPurchase(cloud) ? "Buy quota" : "Retry";
                retryBtn.addEventListener("click", async (event) => {
                    event.stopPropagation();
                    if (requiresQuotaPurchase(cloud)) {
                        scrollToBuyQuotaSection();
                        return;
                    }
                    await retryCloudClassification(Number(cloud.id), name);
                });
                card.appendChild(retryBtn);
            }

            card.appendChild(badge);
            card.appendChild(checkboxWrap);
            card.appendChild(img);
            col.appendChild(card);
            grid.appendChild(col);
        });
        refreshDeleteBar();
    }

    async function loadClouds() {
        const grid = document.getElementById("thumb-grid");
        grid.innerHTML = '<div class="col-12 text-muted">Loading...</div>';
        try {
            const response = await fetch("/clouds", { headers: { "Accept": "application/json" } });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const payload = await response.json();
            const clouds = toCloudItems(payload);
            replaceCloudState(clouds);
            renderCloudsFromState();
        } catch (error) {
            document.getElementById("cloud-payload").textContent = "[]";
            grid.innerHTML = '<div class="col-12 text-danger">Unable to load thumbnails: ' + error.message + '</div>';
        }
    }

    async function uploadClouds(files) {
        const statusNode = document.getElementById("upload-status");
        const selectedFiles = Array.from(files || []).filter((file) => (file.type || "").startsWith("image/"));
        if (selectedFiles.length === 0) {
            statusNode.textContent = "Drop one or more images first.";
            return;
        }

        let successCount = 0;
        let failCount = 0;
        for (const file of selectedFiles) {
            statusNode.textContent = "Requesting upload link for " + file.name + "...";
            try {
                const uploadUrl = await requestUploadUrl(file);
                statusNode.textContent = "Uploading " + file.name + "...";
                const response = await fetch(uploadUrl, {
                    method: "PUT",
                    headers: {
                        "Content-Type": file.type || "application/octet-stream"
                    },
                    body: file
                });
                if (!response.ok) throw new Error("Upload failed with HTTP " + response.status);
                successCount += 1;
            } catch (error) {
                failCount += 1;
                statusNode.textContent = "Upload failed for " + file.name + ": " + error.message;
            }
        }

        statusNode.textContent = "Done: " + successCount + " uploaded, " + failCount + " failed.";
        await loadClouds();
    }

    async function requestUploadUrl(file) {
        const response = await fetch("/clouds/upload-request", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "text/event-stream"
            },
            body: JSON.stringify({
                fileName: file.name,
                contentType: file.type || "application/octet-stream"
            })
        });
        if (!response.ok) {
            const message = await response.text();
            throw new Error("Upload link request failed (" + response.status + "): " + message.trim());
        }
        return await readUploadUrlFromSseResponse(response);
    }

    async function readUploadUrlFromSseResponse(response) {
        if (!response.body) throw new Error("No SSE response body.");
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        while (true) {
            const chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            const events = buffer.split(/\r?\n\r?\n/);
            buffer = events.pop() || "";
            for (const eventBlock of events) {
                const data = eventBlock
                    .split(/\r?\n/)
                    .filter((line) => line.startsWith("data:"))
                    .map((line) => line.slice(5).trim())
                    .join("\n");
                if (!data) continue;
                try {
                    const parsed = JSON.parse(data);
                    if (parsed && parsed.payload) return parsed.payload;
                } catch (_) {
                    if (data.startsWith("http://") || data.startsWith("https://")) return data;
                }
            }
        }
        throw new Error("No upload URL received from SSE stream.");
    }

    async function deleteSelectedClouds() {
        if (selectedCloudIds.size === 0) {
            return;
        }
        const ids = Array.from(selectedCloudIds);
        const response = await fetch("/clouds/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cloudIds: ids })
        });
        if (!response.ok) {
            const message = await response.text();
            document.getElementById("upload-status").textContent = "Delete failed: " + message.trim();
            return;
        }
        selectedCloudIds.clear();
        document.getElementById("upload-status").textContent = "Deleted " + ids.length + " cloud(s).";
        await loadClouds();
    }

    async function retryCloudClassification(cloudId, displayName) {
        const statusNode = document.getElementById("upload-status");
        statusNode.textContent = "Retrying classification for " + displayName + "...";
        const response = await fetch("/clouds/" + encodeURIComponent(String(cloudId)) + "/retry", {
            method: "POST",
            headers: { "Accept": "text/plain" }
        });
        if (!response.ok) {
            const message = await response.text();
            statusNode.textContent = "Retry failed for " + displayName + ": " + (message || ("HTTP " + response.status));
            return;
        }
        statusNode.textContent = "Retry accepted for " + displayName + ".";
    }

    async function requestQuota(packageQuota, packagePrice) {
        const statusNode = document.getElementById("upload-status");
        statusNode.textContent = "Submitting quota request (" + packageQuota + " quota, " + packagePrice + ")...";
        const response = await fetch("/quota-request", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "text/plain" },
            body: JSON.stringify({ packageQuota })
        });
        if (!response.ok) {
            const message = await response.text();
            statusNode.textContent = "Quota request failed: " + (message || ("HTTP " + response.status));
            return;
        }
        statusNode.textContent = "Quota request accepted (" + packageQuota + " quota).";
        if (currentUser) {
            const current = Number(currentUser.remainingQuota);
            if (Number.isFinite(current)) {
                currentUser.remainingQuota = current + packageQuota;
                currentUser.quota = currentUser.remainingQuota;
            }
        }
        await loadUser();
        setTimeout(() => { loadUser(); }, 1000);
        setTimeout(() => { loadUser(); }, 2500);
    }

    const dropZone = document.getElementById("drop-zone");

    dropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropZone.classList.remove("dragover");
        uploadClouds(event.dataTransfer.files || []);
    });

    document.getElementById("delete-btn").addEventListener("click", deleteSelectedClouds);
    document.querySelectorAll(".quota-buy-btn").forEach((button) => {
        button.addEventListener("click", async () => {
            const packageQuota = Number(button.dataset.packageQuota || "10");
            const packagePrice = String(button.dataset.packagePrice || "");
            await requestQuota(packageQuota, packagePrice);
        });
    });

    function openCloudModal(src, title) {
        const modalImg = document.getElementById("cloudModalImage");
        const modalTitle = document.getElementById("cloudModalLabel");
        modalImg.src = src;
        modalTitle.textContent = title;
        const modal = new bootstrap.Modal(document.getElementById("cloudModal"));
        modal.show();
    }

    async function initPage() {
        await loadUser();
        connectCloudStream();
        await loadClouds();
    }

    function connectCloudStream() {
        if (cloudStream) {
            cloudStream.close();
        }
        cloudStream = new EventSource("/clouds/stream");
        cloudStream.onmessage = (event) => {
            if (!event || !event.data) return;
            try {
                const payload = JSON.parse(event.data);
                if (payload && payload.type === "cloud-upserted" && payload.cloud) {
                    upsertCloudState(payload.cloud);
                    renderCloudsFromState();
                } else if (payload && payload.type === "cloud-deleted" && payload.cloud) {
                    removeCloudState(payload.cloud);
                    renderCloudsFromState();
                } else if (payload && payload.type === "quota-updated") {
                    const userName = String(payload.userName || "");
                    const quota = Number(payload.remainingQuota);
                    if (!currentUser) {
                        currentUser = {};
                    }
                    if (!currentUser.userName || currentUser.userName === userName) {
                        if (Number.isFinite(quota)) {
                            currentUser.remainingQuota = quota;
                            currentUser.quota = quota;
                        }
                        refreshQuotaBadge();
                        renderCloudsFromState();
                        const payloadNode = document.getElementById("payload");
                        if (payloadNode) {
                            payloadNode.textContent = JSON.stringify(currentUser, null, 2);
                        }
                    }
                }
            } catch (_) {
            }
        };
        cloudStream.onerror = () => {
            // Browser auto-reconnects EventSource. Keep silent to avoid noisy UI.
        };
    }

    initPage();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
