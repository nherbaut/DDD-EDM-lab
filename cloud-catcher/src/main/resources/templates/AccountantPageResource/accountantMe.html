<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudCatcher - Accountant Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4 py-md-5">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h3 mb-1">Accountant Dashboard</h1>
            <p class="text-muted mb-0">Revenue and quota purchase activity.</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="/">Back to home</a>
            <a class="btn btn-primary btn-sm" href="/logout">Log out</a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h2 class="h6 text-muted mb-2">Money made</h2>
                    <p id="money-made" class="display-6 mb-0">...</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h2 class="h6 text-muted mb-2">Quota bought</h2>
                    <p id="quota-bought" class="display-6 mb-0">...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h2 class="h5">Quota purchase transactions</h2>
            <div class="table-responsive">
                <table class="table table-striped table-sm align-middle mb-0">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>User</th>
                        <th>Quota bought</th>
                        <th>Amount</th>
                    </tr>
                    </thead>
                    <tbody id="tx-body">
                    <tr>
                        <td colspan="4" class="text-muted">Loading...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function eur(amountCents) {
        const euros = Number(amountCents || 0) / 100;
        return euros.toLocaleString(undefined, { style: "currency", currency: "EUR" });
    }

    function formatDate(value) {
        if (!value) return "-";
        try {
            return new Date(value).toLocaleString();
        } catch (_) {
            return String(value);
        }
    }

    async function loadSummary() {
        const moneyNode = document.getElementById("money-made");
        const quotaNode = document.getElementById("quota-bought");
        const txBody = document.getElementById("tx-body");
        const response = await fetch("/api/accounting/summary", {
            headers: { "Accept": "application/json" }
        });
        if (!response.ok) {
            moneyNode.textContent = "Unavailable";
            quotaNode.textContent = "Unavailable";
            txBody.innerHTML = '<tr><td colspan="4" class="text-danger">Unable to load accountant data (HTTP ' + response.status + ").</td></tr>";
            return;
        }
        const payload = await response.json();
        moneyNode.textContent = eur(payload.totalAmountCents);
        quotaNode.textContent = String(payload.totalQuotaBought || 0);
        const tx = Array.isArray(payload.transactions) ? payload.transactions : [];
        if (tx.length === 0) {
            txBody.innerHTML = '<tr><td colspan="4" class="text-muted">No transactions yet.</td></tr>';
            return;
        }
        txBody.innerHTML = "";
        tx.forEach((item) => {
            const tr = document.createElement("tr");
            tr.innerHTML =
                "<td>" + formatDate(item.purchasedAt) + "</td>" +
                "<td>" + String(item.userName || "-") + "</td>" +
                "<td>" + String(item.purchasedQuota || 0) + "</td>" +
                "<td>" + eur(item.amountCents) + "</td>";
            txBody.appendChild(tr);
        });
    }

    loadSummary();
</script>
</body>
</html>
