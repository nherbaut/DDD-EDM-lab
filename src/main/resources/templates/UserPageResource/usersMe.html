<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudCatcher - My Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(180deg, #f4f7fb 0%, #eef4ff 100%);
        }
        .page-shell {
            max-width: 1100px;
            margin: 0 auto;
        }
        .section-card {
            border: 0;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(10, 37, 64, 0.08);
        }
        .thumb-card { position: relative; }
        .thumb-card img { width: 100%; height: 160px; object-fit: cover; }
        .drop-zone {
            border: 2px dashed #8ba7d5;
            border-radius: 1rem;
            padding: 2rem 1rem;
            text-align: center;
            background: #f9fbff;
            transition: all .18s ease;
        }
        .drop-zone.dragover {
            border-color: #0d6efd;
            background: #e8f1ff;
            transform: translateY(-1px);
        }
        .thumb-check { position: absolute; top: .5rem; right: .5rem; z-index: 3; }
        .delete-bar { position: sticky; bottom: 0; z-index: 20; }
        .hero-title {
            letter-spacing: .2px;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4 py-md-5">
    <div class="page-shell">
            <div class="card section-card mb-3">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3 mb-2">
                        <div>
                            <h1 class="h3 hero-title mb-1">My Cloud Space</h1>
                            <p class="text-muted mb-0">Upload your sky photos and manage your cloud gallery.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a class="btn btn-outline-secondary btn-sm" href="/">Back to home</a>
                            <a class="btn btn-primary btn-sm" href="/logout">Log out</a>
                        </div>
                    </div>
                    <p class="text-danger fw-semibold mt-2 mb-0" id="error"></p>
                </div>
            </div>

            <div class="card section-card mb-3">
                <div class="card-body">
                    <h2 class="h5">Upload cloud photos</h2>
                    <p class="text-muted mb-3">Drag and drop images below. Each file is uploaded to the cloud automatically.</p>
                    <div id="drop-zone" class="drop-zone mb-2">
                        <div class="fw-semibold">Drop images here</div>
                        <div class="text-muted small">PNG, JPG and other image formats</div>
                    </div>
                    <p id="upload-status" class="mt-2 mb-0"></p>
                </div>
            </div>

            <div class="card section-card">
                <div class="card-body">
                    <h2 class="h5">Your cloud thumbnails</h2>
                    <div id="thumb-grid" class="row g-3"></div>
                </div>
            </div>
            <div id="delete-bar" class="delete-bar mt-3 d-none">
                <div class="alert alert-danger d-flex justify-content-between align-items-center mb-0 shadow-sm">
                    <span id="delete-count">0 selected</span>
                    <button id="delete-btn" type="button" class="btn btn-danger btn-sm">Delete selected</button>
                </div>
            </div>

            <div class="modal fade" id="cloudModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content bg-dark">
                        <div class="modal-header border-0">
                            <h5 class="modal-title text-white" id="cloudModalLabel">Cloud preview</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body d-flex justify-content-center align-items-center p-2">
                            <img id="cloudModalImage" alt="Cloud full view" class="img-fluid" style="max-height: 95vh; object-fit: contain;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion mt-3" id="debugAccordion">
                <div class="accordion-item border-0 rounded-3 overflow-hidden shadow-sm">
                    <h2 class="accordion-header" id="debugHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#debugCollapse" aria-expanded="false" aria-controls="debugCollapse">
                            Debug (OIDC and user payload)
                        </button>
                    </h2>
                    <div id="debugCollapse" class="accordion-collapse collapse" aria-labelledby="debugHeading" data-bs-parent="#debugAccordion">
                        <div class="accordion-body">
                            <p class="text-muted small mb-2">Authenticated with OIDC. Data source: <code>/api/users/me</code>.</p>
                            <div class="small fw-semibold mb-1">Current user JSON</div>
                            <pre id="payload" class="bg-dark text-light rounded p-3 small mb-3">Loading...</pre>
                            <div class="small fw-semibold mb-1">Current user clouds JSON</div>
                            <pre id="cloud-payload" class="bg-dark text-light rounded p-3 small mb-0">Loading...</pre>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>

<script>
    let currentUser = null;

    async function loadUser() {
        const payloadNode = document.getElementById("payload");
        const cloudPayloadNode = document.getElementById("cloud-payload");
        const errorNode = document.getElementById("error");
        try {
            const response = await fetch("/api/users/me", { headers: { "Accept": "application/json" } });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const user = await response.json();
            currentUser = user;
            payloadNode.textContent = JSON.stringify(user, null, 2);
            if (!cloudPayloadNode.textContent || cloudPayloadNode.textContent === "Loading...") {
                cloudPayloadNode.textContent = "[]";
            }
        } catch (error) {
            errorNode.textContent = "Unable to load user data: " + error.message;
            payloadNode.textContent = "{}";
            cloudPayloadNode.textContent = "[]";
        }
    }

    function toCloudItems(payload) {
        if (Array.isArray(payload.clouds)) return payload.clouds;
        const names = payload.cloudObjectNames || [];
        return names.map((n) => ({ id: null, minioObjectName: n, cloudName: null }));
    }

    const selectedCloudIds = new Set();

    function getCloudOwnerId(cloud) {
        const name = String(cloud.minioObjectName || "");
        const parts = name.split("/");
        return parts.length >= 3 ? parts[1] : "";
    }

    function userIdentityCandidates(user) {
        if (!user) return [];
        return [
            user.id,
            user.userId,
            user.sub,
            user.username,
            user.preferred_username
        ].filter((value) => value !== undefined && value !== null && String(value).trim() !== "").map((value) => String(value));
    }

    function cloudEntitiesForCurrentUser(clouds) {
        const identities = userIdentityCandidates(currentUser);
        if (identities.length === 0) return clouds;
        const filtered = clouds.filter((cloud) => identities.includes(getCloudOwnerId(cloud)));
        return filtered.length > 0 ? filtered : clouds;
    }

    function refreshDeleteBar() {
        const bar = document.getElementById("delete-bar");
        const count = document.getElementById("delete-count");
        count.textContent = selectedCloudIds.size + " selected";
        if (selectedCloudIds.size > 0) {
            bar.classList.remove("d-none");
        } else {
            bar.classList.add("d-none");
        }
    }

    async function loadClouds() {
        const grid = document.getElementById("thumb-grid");
        grid.innerHTML = '<div class="col-12 text-muted">Loading...</div>';
        try {
            const response = await fetch("/clouds", { headers: { "Accept": "application/json" } });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const payload = await response.json();
            const clouds = toCloudItems(payload);
            const userClouds = cloudEntitiesForCurrentUser(clouds);
            document.getElementById("cloud-payload").textContent = JSON.stringify(userClouds, null, 2);
            if (clouds.length === 0) {
                grid.innerHTML = '<div class="col-12 text-muted">No uploaded clouds yet.</div>';
                return;
            }
            grid.innerHTML = "";
            clouds.forEach((cloud) => {
                const name = String(cloud.minioObjectName || "");
                const parts = name.split("/");
                if (parts.length < 3) return;
                const userId = parts[1];
                const fileName = parts.slice(2).join("/");

                const col = document.createElement("div");
                col.className = "col-6 col-md-4 col-lg-3";

                const card = document.createElement("div");
                card.className = "card thumb-card shadow-sm border-0";

                const badge = document.createElement("span");
                badge.className = "position-absolute top-0 start-0 translate-middle-y badge rounded-pill bg-primary ms-3 mt-2";
                badge.textContent = cloud.cloudName || "pending";

                const checkboxWrap = document.createElement("div");
                checkboxWrap.className = "thumb-check form-check";
                const checkbox = document.createElement("input");
                checkbox.className = "form-check-input";
                checkbox.type = "checkbox";
                checkbox.checked = cloud.id != null && selectedCloudIds.has(Number(cloud.id));
                checkbox.disabled = cloud.id == null;
                checkbox.title = cloud.id == null ? "Missing cloud id" : "Select for deletion";
                checkbox.addEventListener("click", (event) => event.stopPropagation());
                checkbox.addEventListener("change", () => {
                    if (cloud.id == null) return;
                    const id = Number(cloud.id);
                    if (checkbox.checked) selectedCloudIds.add(id);
                    else selectedCloudIds.delete(id);
                    refreshDeleteBar();
                });
                checkboxWrap.appendChild(checkbox);

                const img = document.createElement("img");
                img.className = "card-img-top rounded";
                img.loading = "lazy";
                img.alt = name;
                img.src = "/cloud/" + encodeURIComponent(userId) + "/" + encodeURIComponent(fileName);
                img.style.cursor = "zoom-in";
                img.addEventListener("click", () => openCloudModal(img.src, cloud.cloudName || name));

                card.appendChild(badge);
                card.appendChild(checkboxWrap);
                card.appendChild(img);
                col.appendChild(card);
                grid.appendChild(col);
            });
            refreshDeleteBar();
        } catch (error) {
            document.getElementById("cloud-payload").textContent = "[]";
            grid.innerHTML = '<div class="col-12 text-danger">Unable to load thumbnails: ' + error.message + '</div>';
        }
    }

    async function uploadClouds(files) {
        const statusNode = document.getElementById("upload-status");
        const selectedFiles = Array.from(files || []).filter((file) => (file.type || "").startsWith("image/"));
        if (selectedFiles.length === 0) {
            statusNode.textContent = "Drop one or more images first.";
            return;
        }

        let successCount = 0;
        let failCount = 0;
        for (const file of selectedFiles) {
            statusNode.textContent = "Uploading " + file.name + "...";
            const response = await fetch("/clouds", {
                method: "POST",
                headers: {
                    "Content-Type": file.type || "application/octet-stream",
                    "X-File-Name": file.name
                },
                body: file
            });
            if (response.ok) successCount += 1;
            else failCount += 1;
        }

        statusNode.textContent = "Done: " + successCount + " uploaded, " + failCount + " failed.";
        await loadClouds();
    }

    async function deleteSelectedClouds() {
        if (selectedCloudIds.size === 0) {
            return;
        }
        const ids = Array.from(selectedCloudIds);
        const response = await fetch("/clouds/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cloudIds: ids })
        });
        if (!response.ok) {
            const message = await response.text();
            document.getElementById("upload-status").textContent = "Delete failed: " + message.trim();
            return;
        }
        selectedCloudIds.clear();
        document.getElementById("upload-status").textContent = "Deleted " + ids.length + " cloud(s).";
        await loadClouds();
    }

    const dropZone = document.getElementById("drop-zone");

    dropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropZone.classList.remove("dragover");
        uploadClouds(event.dataTransfer.files || []);
    });

    document.getElementById("delete-btn").addEventListener("click", deleteSelectedClouds);

    function openCloudModal(src, title) {
        const modalImg = document.getElementById("cloudModalImage");
        const modalTitle = document.getElementById("cloudModalLabel");
        modalImg.src = src;
        modalTitle.textContent = title;
        const modal = new bootstrap.Modal(document.getElementById("cloudModal"));
        modal.show();
    }

    async function initPage() {
        await loadUser();
        await loadClouds();
    }

    initPage();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
